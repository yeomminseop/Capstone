import pandas as pd

# 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
file_path = "Medicine/filtered_medicine_info.csv"  # íŒŒì¼ ê²½ë¡œ ë§ê²Œ ìˆ˜ì •
medicine_df = pd.read_csv(file_path)

# 2. ATC_3 ì½”ë“œ â†’ ë‚´ë¶€ íš¨ëŠ¥ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
atc3_effect_mapping = {
    "A11J": "ì˜ì–‘ì œ(ê¸°íƒ€ ë¹„íƒ€ë¯¼)",
    "R05X": "ê¸°íƒ€ í˜¸í¡ê¸°ê³„ì•½ë¬¼",
    "M02A": "êµ­ì†Œ ì§„í†µì†Œì—¼ì œ",
    "M01A": "ë¹„ìŠ¤í…Œë¡œì´ë“œì„± ì†Œì—¼ì§„í†µì œ",
    "R05C": "ê±°ë‹´ì œ",
    "R05D": "ê¸°ì¹¨ ì–µì œì œ",
    "A06A": "ì™„í•˜ì œ",
    "A07E": "ì§€ì‚¬ì œ",
    "R01B": "ë¹„ì¶©í˜ˆ ì œê±°ì œ",
    "R06A": "í•­íˆìŠ¤íƒ€ë¯¼ì œ",
    "N02B": "í•´ì—´ì§„í†µì œ",
    "A11C": "ë¹„íƒ€ë¯¼ A, D ë° ì¡°í•©",
    "A02B": "ìœ„ì‚°ë¶„ë¹„ì–µì œì œ",
    "A01A": "êµ¬ê°•ìš© ì†Œë…ì œ",
    "A05B": "ê°„ê¸°ëŠ¥ ê°œì„ ì œ",
    "A12C": "ë¯¸ë„¤ë„ ë³´ì¶©ì œ",
    "D08A": "êµ­ì†Œ ì‚´ê· ì†Œë…ì œ",
    "A13A": "ëŒ€ì‚¬ì´‰ì§„ì œ",
    "A04A": "í•­êµ¬í† ì œ",
    "N05C": "ìˆ˜ë©´ì œ ë° ì§„ì •ì œ",
    "N05B": "í•­ë¶ˆì•ˆì œ",
    "M03B": "ê·¼ì´ì™„ì œ",
    "D04A": "í”¼ë¶€ì§ˆí™˜ ì¹˜ë£Œì œ",
    "D06A": "êµ­ì†Œ í•­ìƒì œ",
    "A07D": "ì†Œí™”ê¸°ê³„ í•­ê°ì—¼ì œ"
}

# 3. ì¦ìƒ í‚¤ì›Œë“œ â†’ ë³µìˆ˜ íš¨ëŠ¥ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
symptom_to_effects = {
    "ë‘í†µ": ["í•´ì—´ì§„í†µì œ"],
    "ê°ê¸°": ["ê¸°íƒ€ í˜¸í¡ê¸°ê³„ì•½ë¬¼", "ê¸°ì¹¨ ì–µì œì œ", "ê±°ë‹´ì œ"],
    "ì¸í›„ì—¼": ["êµ¬ê°•ìš© ì†Œë…ì œ"],
    "ì•Œë ˆë¥´ê¸°": ["í•­íˆìŠ¤íƒ€ë¯¼ì œ"],
    "ê¸°ì¹¨": ["ê¸°ì¹¨ ì–µì œì œ", "ê±°ë‹´ì œ"],
    "ì½§ë¬¼": ["í•­íˆìŠ¤íƒ€ë¯¼ì œ"],
    "ë°œì—´": ["í•´ì—´ì§„í†µì œ"],
    "ìœ„ì—¼": ["ìœ„ì‚°ë¶„ë¹„ì–µì œì œ"],
    "ì†Œí™”ë¶ˆëŸ‰": ["ìœ„ì‚°ë¶„ë¹„ì–µì œì œ"],
    "ìŠ¤íŠ¸ë ˆìŠ¤ì„± ì†Œí™”ì¥ì• ": ["ìœ„ì‚°ë¶„ë¹„ì–µì œì œ"],
    "ì„¤ì‚¬": ["ì§€ì‚¬ì œ"],
    "ë³€ë¹„": ["ì™„í•˜ì œ"],
    "ì¥íŠ¸ëŸ¬ë¸”": ["ì§€ì‚¬ì œ", "ì™„í•˜ì œ"],
    "í”¼ë¶€ì—¼": ["êµ­ì†Œ ì‚´ê· ì†Œë…ì œ"],
    "ê°€ë ¤ì›€ì¦": ["í•­íˆìŠ¤íƒ€ë¯¼ì œ", "í”¼ë¶€ì§ˆí™˜ ì¹˜ë£Œì œ"],
    "í”¼ë¡œëˆ„ì ": ["ëŒ€ì‚¬ì´‰ì§„ì œ", "ì˜ì–‘ì œ(ê¸°íƒ€ ë¹„íƒ€ë¯¼)"],
    "ìƒë¦¬í†µ": ["í•´ì—´ì§„í†µì œ", "ë¹„ìŠ¤í…Œë¡œì´ë“œì„± ì†Œì—¼ì§„í†µì œ"],
    "ê·¼ìœ¡í†µ": ["êµ­ì†Œ ì§„í†µì†Œì—¼ì œ"],
    "í—ˆë¦¬í†µì¦": ["ë¹„ìŠ¤í…Œë¡œì´ë“œì„± ì†Œì—¼ì§„í†µì œ"],
    "ê´€ì ˆí†µ": ["ë¹„ìŠ¤í…Œë¡œì´ë“œì„± ì†Œì—¼ì§„í†µì œ"],
    "êµ¬ê°•ì—¼/ì…ë³‘": ["êµ¬ê°•ìš© ì†Œë…ì œ"],
    "ë©€ë¯¸": ["í•­êµ¬í† ì œ"],
    "ìˆ˜ë©´ì¥ì• ": ["ìˆ˜ë©´ì œ ë° ì§„ì •ì œ"],
    "ë¶ˆì•ˆì¦": ["í•­ë¶ˆì•ˆì œ"],
    "ëˆˆí”¼ë¡œ": ["ë¹„íƒ€ë¯¼ A, D ë° ì¡°í•©"],
    "ê·¼ìœ¡ê²½ë ¨": ["ê·¼ì´ì™„ì œ"]
}


# 4. eì•½ì€ìš” ë§í¬ ìƒì„± (e_code ì‚¬ìš©)
def generate_e_drug_url(e_code):
    if pd.isna(e_code):  # e_codeê°€ NaNì´ë©´ ë§í¬ ì—†ìŒ ì²˜ë¦¬
        return "ë§í¬ì—†ìŒ"
    e_code_int = int(float(e_code))  # floatë¥¼ intë¡œ ë³€í™˜í•´ì„œ .0 ì™„ë²½ ì œê±°
    e_code_str = str(e_code_int)
    base_url = "https://nedrug.mfds.go.kr/searchEasyDrug/easyDetail?itemSeq="
    return base_url + e_code_str


# 5. ë°ì´í„° ì „ì²˜ë¦¬: íš¨ëŠ¥ ë§¤í•‘
medicine_df['effect_category'] = medicine_df['atc_3'].map(atc3_effect_mapping)
medicine_df['effect_category'] = medicine_df['effect_category'].fillna('ê¸°íƒ€(Other)')


# 6. ì¶”ì²œ ì‹œìŠ¤í…œ í•¨ìˆ˜ (ëœë¤ X, ì „ì²´ ì¶œë ¥)
def recommend_by_symptom_grouped(symptom_keyword, data):
    """
    ì¦ìƒ í‚¤ì›Œë“œ ê¸°ë°˜ ë³µìˆ˜ íš¨ëŠ¥ ë§¤ì¹­ + íš¨ëŠ¥ë³„ ì „ì²´ ì œí’ˆ ì¶œë ¥ ì‹œìŠ¤í…œ
    """
    effect_list = symptom_to_effects.get(symptom_keyword)

    if not effect_list:
        print(f"âŒ '{symptom_keyword}'ì— í•´ë‹¹í•˜ëŠ” ë“±ë¡ëœ íš¨ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    print(f"\nâœ… '{symptom_keyword}' ê´€ë ¨ ì¶”ì²œ ì œí’ˆ (íš¨ëŠ¥ë³„ ê·¸ë£¹í•‘)\n")

    for effect in effect_list:
        matched = data[data['effect_category'] == effect].copy()  # âœ… ìŠ¬ë¼ì´ìŠ¤ copy ì¶”ê°€

        if matched.empty:
            continue

        matched['eì•½ì€ìš”_ë§í¬'] = matched['e_code'].apply(generate_e_drug_url)

        print(f"\nğŸ©º [íš¨ëŠ¥: {effect}]")
        display_cols = ['product_name', 'comp', 'eì•½ì€ìš”_ë§í¬']
        print(matched[display_cols].to_string(index=False))


# 7. ë©”ì¸ ì‹¤í–‰
if __name__ == "__main__":
    print("ğŸ’Š ê³ ë„í™”ëœ ì˜ì•½í’ˆ ì¶”ì²œ ì‹œìŠ¤í…œì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!")

    while True:
        keyword = input("\nì°¾ê³  ì‹¶ì€ ì¦ìƒ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë‘í†µ, ê°ê¸°, ì¸í›„ì—¼, ì•Œë ˆë¥´ê¸° ë“±) (ì¢…ë£Œí•˜ë ¤ë©´ 'exit') : ")

        if keyword.lower() == 'exit':
            print("í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤. ğŸ‘‹")
            break
        else:
            recommend_by_symptom_grouped(
                symptom_keyword=keyword,
                data=medicine_df
            )